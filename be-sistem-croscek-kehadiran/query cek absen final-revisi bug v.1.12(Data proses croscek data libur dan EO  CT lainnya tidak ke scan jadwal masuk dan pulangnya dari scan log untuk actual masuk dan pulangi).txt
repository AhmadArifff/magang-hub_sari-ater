SELECT
                base.Nama,
                base.Tanggal,
                base.Kode_Shift,
                base.Jabatan,
                base.Departemen,
                base.id_karyawan,
                base.NIK,
                base.Jadwal_Masuk,
                base.Jadwal_Pulang,
                base.Actual_Masuk,
                base.Actual_Pulang,

                CASE
                    WHEN base.Kode_Shift IN ('CT','CTT','EO','OF1','CTB','X')
                        THEN ij.keterangan
                    WHEN base.Actual_Masuk IS NULL AND base.Actual_Pulang IS NULL
                        THEN 'Tidak Hadir'
                    ELSE 'Hadir'
                END AS Status_Kehadiran,

                CASE
                    WHEN base.Actual_Masuk IS NULL THEN 'Tidak scan masuk'
                    WHEN base.Actual_Masuk <= base.Scheduled_Start THEN 'Masuk Tepat Waktu'
                    ELSE 'Masuk Telat'
                END AS Status_Masuk,

                CASE
                    WHEN base.Actual_Pulang IS NULL THEN 'Tidak scan pulang'
                    WHEN base.Actual_Pulang >= base.Scheduled_End THEN 'Pulang Tepat Waktu'
                    ELSE 'Pulang Terlalu Cepat'
                END AS Status_Pulang

            FROM (

                SELECT
                    jk.nama AS Nama,
                    jk.tanggal AS Tanggal,
                    jk.kode_shift AS Kode_Shift,
                    si.jam_masuk AS Jadwal_Masuk,
                    si.jam_pulang AS Jadwal_Pulang,

                    k.jabatan AS Jabatan,
                    k.dept AS Departemen,
                    k.id_karyawan,
                    k.nik,

                    CAST(CONCAT(jk.tanggal, ' ', si.jam_masuk) AS DATETIME) AS Scheduled_Start,

                    CASE
                        WHEN si.jam_pulang < si.jam_masuk
                            THEN CAST(CONCAT(DATE_ADD(jk.tanggal, INTERVAL 1 DAY), ' ', si.jam_pulang) AS DATETIME)
                        ELSE CAST(CONCAT(jk.tanggal, ' ', si.jam_pulang) AS DATETIME)
                    END AS Scheduled_End,

                    /* =====================
                    ACTUAL MASUK (AMAN)
                    ===================== */
                    CASE
                        WHEN jk.kode_shift IN ('CT','CTT','EO','OF1','CTB','X') THEN NULL
                        ELSE (
                            SELECT MIN(k3.tanggal_scan)
                            FROM kehadiran_karyawan k3
                            WHERE k3.nama = jk.nama
                            AND k3.tanggal_scan BETWEEN
                                (CAST(CONCAT(jk.tanggal, ' ', si.jam_masuk) AS DATETIME) - INTERVAL 4 HOUR)
                                AND (CAST(CONCAT(jk.tanggal, ' ', si.jam_masuk) AS DATETIME) + INTERVAL 4 HOUR)
                        )
                    END AS Actual_Masuk,

                    /* =====================
                    ACTUAL PULANG (FIX UTAMA)
                    ===================== */
                    CASE
                        WHEN jk.kode_shift IN ('CT','CTT','EO','OF1','CTB','X') THEN NULL
                        ELSE (
                            SELECT MAX(k4.tanggal_scan)
                            FROM kehadiran_karyawan k4
                            WHERE k4.nama = jk.nama
                            AND DATE(k4.tanggal_scan) IN (
                                jk.tanggal,
                                DATE_ADD(jk.tanggal, INTERVAL 1 DAY)
                            )
                            AND k4.tanggal_scan BETWEEN
                                (
                                    CASE WHEN si.jam_pulang < si.jam_masuk
                                        THEN CAST(CONCAT(DATE_ADD(jk.tanggal, INTERVAL 1 DAY), ' ', si.jam_pulang) AS DATETIME)
                                        ELSE CAST(CONCAT(jk.tanggal, ' ', si.jam_pulang) AS DATETIME)
                                    END - INTERVAL 6 HOUR
                                )
                                AND
                                (
                                    CASE WHEN si.jam_pulang < si.jam_masuk
                                        THEN CAST(CONCAT(DATE_ADD(jk.tanggal, INTERVAL 1 DAY), ' ', si.jam_pulang) AS DATETIME)
                                        ELSE CAST(CONCAT(jk.tanggal, ' ', si.jam_pulang) AS DATETIME)
                                    END + INTERVAL 6 HOUR
                                )
                        )
                    END AS Actual_Pulang

                FROM jadwal_karyawan jk
                LEFT JOIN shift_info si ON jk.kode_shift = si.kode
                LEFT JOIN karyawan k ON jk.id_karyawan = k.id_karyawan

                GROUP BY
                    jk.nama, jk.tanggal, jk.kode_shift,
                    si.jam_masuk, si.jam_pulang,
                    k.jabatan, k.dept, k.id_karyawan, k.nik

            ) AS base

            LEFT JOIN informasi_jadwal ij ON ij.kode = base.Kode_Shift
            ORDER BY base.Nama, base.Tanggal;